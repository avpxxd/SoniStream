<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoniStream Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600&display=swap');
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #050505;
            color: white;
            overflow: hidden; /* Prevent scrollbars */
        }

        /* Custom Scrollbar for playlist */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05); 
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4); 
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        #ui-layer {
            position: relative;
            z-index: 10;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            pointer-events: none;
        }

        .interactive {
            pointer-events: auto;
        }

        /* Playlist Item Styling */
        .playlist-item {
            transition: all 0.2s ease;
            border-left: 2px solid transparent;
        }
        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .playlist-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 2px solid #a855f7; /* Purple-500 */
        }
        .playlist-item.active .track-title {
            color: #a855f7;
            font-weight: 600;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            /* Height increased to match thumb to prevent misalignment */
            height: 16px; 
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            outline: none;
            /* Ensure track background is centered and thin */
            background-size: 100% 4px;
            background-position: center;
            background-repeat: no-repeat;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            /* Margin removed as track and thumb are now same height context */
            margin-top: 0px; 
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            position: relative;
            z-index: 2;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 16px; /* Match input height */
            cursor: pointer;
            background: transparent;
            border: none;
        }

        /* Loading EQ Animation */
        .loader-bar {
            width: 12px;
            background: linear-gradient(to top, #ea580c, #fb923c);
            border-radius: 4px;
            animation: equalize 1s infinite ease-in-out;
        }
        @keyframes equalize {
            0%, 100% { height: 20%; }
            50% { height: 100%; }
        }
    </style>
</head>
<body>

    <!-- Main Canvas -->
    <canvas id="visualizer-canvas"></canvas>

    <!-- UI Overlay -->
    <div id="ui-layer">
        
        <!-- Header Area -->
        <header class="p-6 relative w-full h-full pointer-events-none">
            
            <!-- Top Left: Title -->
            <div class="absolute top-6 left-6 pointer-events-auto">
                <h1 class="text-3xl font-bold tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-600">
                    SONI<span class="font-light text-white hidden md:inline">STREAM</span><span class="font-light text-white md:hidden">S</span>
                </h1>
                <p id="status-text" class="text-xs text-gray-400 mt-1 uppercase tracking-widest">Ready</p>
            </div>

            <!-- Top Center: Visualizer Controls -->
            <div class="absolute top-6 left-1/2 -translate-x-1/2 pointer-events-auto">
                 <div class="glass-panel rounded-full p-1 flex space-x-1 relative">
                    <div id="selector-pill" class="absolute bg-white rounded-full transition-all duration-300 ease-out shadow-sm" style="opacity: 0;"></div>
                    <button onclick="setVisualizerMode('bars')" id="btn-bars" class="relative z-10 px-4 py-2 rounded-full text-sm font-medium transition-colors duration-300">Bars</button>
                    <button onclick="setVisualizerMode('radial')" id="btn-radial" class="relative z-10 px-4 py-2 rounded-full text-sm font-medium transition-colors duration-300">Radial</button>
                </div>
            </div>

            <!-- Top Right: Playlist Container -->
            <div class="absolute top-6 right-6 flex flex-col items-end pointer-events-auto z-40">
                
                <!-- Mobile Toggles (Visible only on small screens) -->
                <div class="flex gap-3 md:hidden mb-2">
                    <button onclick="openAddModal()" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-white hover:bg-white/10 transition shadow-lg">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <button onclick="toggleMobilePlaylist()" id="mobile-queue-btn" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-white hover:bg-white/10 transition shadow-lg">
                        <i class="fa-solid fa-list"></i>
                    </button>
                </div>

                <!-- Playlist Wrapper (Hidden on mobile by default, Flex on Desktop) -->
                <div id="playlist-wrapper" class="hidden md:flex flex-col gap-2 w-72 transition-all duration-300">
                    
                    <!-- Playlist Square -->
                    <div class="glass-panel rounded-xl overflow-hidden flex flex-col h-64">
                        <div class="p-3 border-b border-white/10 flex justify-between items-center bg-black/20">
                            <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Current Queue</span>
                            <span id="playlist-count" class="text-[10px] bg-white/10 px-2 py-0.5 rounded-full text-gray-300">0</span>
                        </div>
                        
                        <!-- Playlist Content Area -->
                        <div class="relative flex-1 overflow-hidden">
                            <!-- Empty State -->
                            <div id="empty-playlist-msg" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 text-sm italic opacity-60 z-0">
                                <i class="fa-solid fa-music mb-2 text-xl"></i>
                                <span>No tracks added</span>
                            </div>
                            
                            <!-- Track List -->
                            <div id="playlist-container" class="absolute inset-0 overflow-y-auto p-2 space-y-1 z-10">
                                <!-- Tracks injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Desktop Add Button (Hidden on mobile since we have the circle button) -->
                    <button onclick="openAddModal()" class="hidden md:flex w-full py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-xl font-bold shadow-lg shadow-purple-900/40 transition items-center justify-center gap-2 text-sm">
                        <i class="fa-solid fa-plus"></i> Add Track
                    </button>
                </div>
            </div>
        </header>

        <!-- Add Track Modal -->
        <div id="add-modal" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md interactive">
            <div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4 text-center">
                <h3 class="text-xl font-bold mb-6">Add to Playlist</h3>
                
                <div class="space-y-3">
                    <!-- SoundCloud Option -->
                    <button onclick="showSoundCloudInput()" class="w-full px-4 py-4 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold transition flex items-center justify-center gap-3 group">
                        <i class="fa-brands fa-soundcloud text-xl group-hover:scale-110 transition-transform"></i> 
                        <span>Add from SoundCloud</span>
                    </button>
                    
                    <!-- Divider -->
                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div>
                        <div class="relative flex justify-center text-xs uppercase"><span class="bg-[#18181b] px-2 text-gray-500">Or</span></div>
                    </div>

                    <!-- Upload Option -->
                    <label class="w-full px-4 py-4 bg-white/10 hover:bg-white/20 border border-white/10 rounded-lg cursor-pointer transition flex items-center justify-center gap-3 group">
                        <i class="fa-solid fa-file-audio text-blue-400 group-hover:scale-110 transition-transform"></i>
                        <span>Upload Audio File</span>
                        <input type="file" id="file-input" accept="audio/*" class="hidden" onchange="handleFileUpload(this)">
                    </label>

                    <!-- Demo Tracks Button -->
                    <button onclick="showDemoSelection()" class="w-full px-4 py-3 bg-transparent hover:bg-white/5 border border-dashed border-gray-600 hover:border-white/50 rounded-lg text-gray-400 hover:text-white transition flex items-center justify-center gap-2 text-sm mt-4">
                        <i class="fa-solid fa-compact-disc"></i> Use Demo Tracks
                    </button>
                </div>
                
                <button onclick="closeAddModal()" class="mt-6 text-sm text-gray-400 hover:text-white underline">Cancel</button>
            </div>
        </div>

        <!-- SoundCloud Link Input Sub-Modal -->
        <div id="sc-input-modal" class="hidden absolute inset-0 z-[55] flex items-center justify-center bg-black/90 interactive">
            <div class="glass-panel p-6 rounded-xl w-full max-w-md mx-4">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fa-brands fa-soundcloud text-orange-500"></i> Paste Link
                </h3>
                <input type="text" id="sc-input" placeholder="https://soundcloud.com/artist/track..." class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 mb-2 text-white focus:outline-none focus:border-orange-500 transition">
                <p class="text-[10px] text-gray-400 mb-6 italic">* Visualizer runs in simulation mode for SoundCloud streams.</p>
                <div class="flex justify-end gap-3">
                     <button onclick="closeSoundCloudInput()" class="px-4 py-2 text-gray-300 hover:text-white transition">Back</button>
                     <button onclick="addSoundCloudTrack()" class="px-6 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold shadow-lg shadow-orange-900/30 transition">Add to Queue</button>
                </div>
            </div>
        </div>

        <!-- Demo Selection Sub-Modal -->
        <div id="demo-input-modal" class="hidden absolute inset-0 z-[55] flex items-center justify-center bg-black/90 interactive">
            <div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-compact-disc text-purple-400"></i> Select Demo Track
                </h3>
                
                <div class="space-y-2 mb-6 max-h-60 overflow-y-auto pr-2">
                    <button onclick="addDemoTrack('1.mp3', 'Demo Track 1')" class="w-full text-left px-4 py-3 text-sm bg-white/5 hover:bg-purple-600/20 text-gray-300 hover:text-white rounded-lg transition flex justify-between items-center group">
                        <span>Demo Track 1</span>
                        <i class="fa-solid fa-plus text-xs opacity-0 group-hover:opacity-100 transition-opacity text-purple-400"></i>
                    </button>
                    <button onclick="addDemoTrack('2.mp3', 'Demo Track 2')" class="w-full text-left px-4 py-3 text-sm bg-white/5 hover:bg-purple-600/20 text-gray-300 hover:text-white rounded-lg transition flex justify-between items-center group">
                        <span>Demo Track 2</span>
                        <i class="fa-solid fa-plus text-xs opacity-0 group-hover:opacity-100 transition-opacity text-purple-400"></i>
                    </button>
                    <button onclick="addDemoTrack('3.mp3', 'Demo Track 3')" class="w-full text-left px-4 py-3 text-sm bg-white/5 hover:bg-purple-600/20 text-gray-300 hover:text-white rounded-lg transition flex justify-between items-center group">
                        <span>Demo Track 3</span>
                        <i class="fa-solid fa-plus text-xs opacity-0 group-hover:opacity-100 transition-opacity text-purple-400"></i>
                    </button>
                    <button onclick="addDemoTrack('4.mp3', 'Demo Track 4')" class="w-full text-left px-4 py-3 text-sm bg-white/5 hover:bg-purple-600/20 text-gray-300 hover:text-white rounded-lg transition flex justify-between items-center group">
                        <span>Demo Track 4</span>
                        <i class="fa-solid fa-plus text-xs opacity-0 group-hover:opacity-100 transition-opacity text-purple-400"></i>
                    </button>
                    <button onclick="addDemoTrack('5.mp3', 'Demo Track 5')" class="w-full text-left px-4 py-3 text-sm bg-white/5 hover:bg-purple-600/20 text-gray-300 hover:text-white rounded-lg transition flex justify-between items-center group">
                        <span>Demo Track 5</span>
                        <i class="fa-solid fa-plus text-xs opacity-0 group-hover:opacity-100 transition-opacity text-purple-400"></i>
                    </button>
                </div>

                <div class="flex justify-end gap-3">
                     <button onclick="closeDemoSelection()" class="px-4 py-2 text-gray-300 hover:text-white transition">Back</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="hidden absolute inset-0 z-[60] flex flex-col items-center justify-center bg-black/90 backdrop-blur-md transition-opacity duration-300 pointer-events-auto">
            <div class="h-24 flex items-end gap-2 mb-6">
                <div class="loader-bar h-full" style="animation-delay: 0.0s"></div>
                <div class="loader-bar h-full" style="animation-delay: 0.2s"></div>
                <div class="loader-bar h-full" style="animation-delay: 0.4s"></div>
                <div class="loader-bar h-full" style="animation-delay: 0.1s"></div>
                <div class="loader-bar h-full" style="animation-delay: 0.3s"></div>
            </div>
            <p class="text-orange-500 font-bold tracking-[0.3em] text-sm animate-pulse">LOADING TRACK</p>
        </div>

        <!-- Hidden SoundCloud Player Container (Must be an iframe for Widget API) -->
        <iframe id="sc-player" class="fixed opacity-0 pointer-events-none -z-10" width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay" src=""></iframe>

        <!-- Bottom Controls -->
        <div class="p-6 interactive mt-auto">
            <div class="glass-panel rounded-2xl p-4 max-w-2xl mx-auto w-full">
                
                <!-- Track Info & Time -->
                <div class="flex justify-between text-xs text-gray-400 mb-2">
                    <span id="track-name">No track playing</span>
                    <span id="track-time">0:00 / 0:00</span>
                </div>

                <!-- Progress Bar -->
                <div class="mb-4 relative group">
                    <input type="range" id="seek-slider" min="0" max="100" value="0" disabled oninput="seekAudio(this.value)">
                </div>

                <!-- Controls Row -->
                <div class="flex items-center justify-between">
                    
                    <!-- Volume (Split Mobile/Desktop) -->
                    <div class="flex items-center gap-3 w-1/3 relative">
                        
                        <!-- Desktop: Mute Icon + Horizontal Slider -->
                        <div class="hidden md:flex items-center gap-3">
                            <button onclick="toggleMute()" class="text-gray-300 hover:text-white">
                                <i id="vol-icon-desktop" class="fa-solid fa-volume-high"></i>
                            </button>
                            <input type="range" id="volume-slider-desktop" min="0" max="1" step="0.01" value="0.8" oninput="setVolume(this.value)" class="w-24">
                        </div>

                        <!-- Mobile: Volume Icon (Toggles Vertical Slider) -->
                        <div class="md:hidden relative">
                            <button onclick="toggleMobileVolume()" class="text-gray-300 hover:text-white p-2">
                                <i id="vol-icon-mobile" class="fa-solid fa-volume-high"></i>
                            </button>
                            
                            <!-- Vertical Popup -->
                            <div id="mobile-vol-container" class="hidden absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 glass-panel rounded-full flex flex-col items-center gap-2 shadow-2xl z-50 w-12">
                                 <div class="h-32 flex items-center justify-center">
                                     <!-- Rotated range input for verticality -->
                                    <input type="range" id="volume-slider-mobile" min="0" max="1" step="0.01" value="0.8" oninput="setVolume(this.value)" 
                                    style="transform: rotate(-90deg); width: 120px; transform-origin: center;" 
                                    class="appearance-none cursor-pointer">
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- Play/Pause Controls -->
                    <div class="flex items-center gap-6 justify-center w-1/3">
                         <button onclick="playPrev()" class="text-gray-400 hover:text-white transition hover:scale-110">
                            <i class="fa-solid fa-backward-step"></i>
                        </button>

                        <button id="play-btn" onclick="togglePlay()" class="w-12 h-12 rounded-full bg-white text-black flex items-center justify-center hover:scale-105 transition disabled:opacity-50" disabled>
                            <i class="fa-solid fa-play"></i>
                        </button>

                        <button onclick="playNext(true)" class="text-gray-400 hover:text-white transition hover:scale-110">
                            <i class="fa-solid fa-forward-step"></i>
                        </button>
                    </div>

                    <!-- Shuffle / Loop Controls -->
                    <div class="flex items-center justify-end gap-4 w-1/3">
                        <button id="shuffle-btn" onclick="toggleShuffle()" class="text-gray-400 hover:text-white text-sm transition" title="Shuffle Playlist">
                            <i class="fa-solid fa-shuffle"></i>
                        </button>
                        <button id="loop-btn" onclick="toggleLoop()" class="text-gray-400 hover:text-white text-sm transition" title="Loop Track">
                            <i class="fa-solid fa-repeat"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        let audioContext;
        let audioSource;
        let analyser;
        let gainNode;
        let audioElement; // For file playback
        
        // Playlist State
        let playlist = []; // { title, type, src (url or blob), object (for file) }
        let currentTrackIndex = -1;
        let isShuffle = false;
        let isLooping = false;

        // SoundCloud State
        let isSoundCloudMode = false;
        let scWidget = null;
        let scDuration = 0; 
        let scPollInterval;

        let isPlaying = false;
        let animationId;
        
        // Canvas Setup
        const canvas = document.getElementById('visualizer-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        // Visualizer State
        let currentMode = 'bars'; 
        let dataArray, bufferLength;
        // Particles mode removed

        // --- Initialization ---

        function updateRangeBackground(el) {
            const min = parseFloat(el.min) || 0;
            const max = parseFloat(el.max) || 100;
            const val = parseFloat(el.value) || 0;
            const percentage = ((val - min) / (max - min)) * 100;
            el.style.background = `linear-gradient(to right, #ffffff ${percentage}%, rgba(255,255,255,0.2) ${percentage}%)`;
            // Re-apply size/position properties as setting style.background overrides all props
            el.style.backgroundSize = '100% 4px';
            el.style.backgroundPosition = 'center';
            el.style.backgroundRepeat = 'no-repeat';
        }

        window.addEventListener('DOMContentLoaded', () => {
             // Init Desktop Volume
             const volDesk = document.getElementById('volume-slider-desktop');
             if(volDesk) updateRangeBackground(volDesk);
             
             // Init Mobile Volume
             const volMob = document.getElementById('volume-slider-mobile');
             if(volMob) updateRangeBackground(volMob);

             const seek = document.getElementById('seek-slider');
             if(seek) updateRangeBackground(seek);
             
             setTimeout(() => setVisualizerMode('bars'), 100);

             // Load SoundCloud Widget API
             const tag = document.createElement('script');
             tag.src = "https://w.soundcloud.com/player/api.js";
             document.body.appendChild(tag);
             
             // Close mobile volume on global click
             document.addEventListener('click', (e) => {
                 const container = document.getElementById('mobile-vol-container');
                 const btn = document.getElementById('vol-icon-mobile');
                 // If click is outside container and NOT on the button itself
                 if(container && !container.classList.contains('hidden')) {
                     if (!container.contains(e.target) && !btn.parentElement.contains(e.target)) {
                         container.classList.add('hidden');
                     }
                 }
             });
        });

        function resizeCanvas() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.85;
                gainNode = audioContext.createGain();
                gainNode.gain.value = 0.8;
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // --- Playlist Logic ---
        
        function toggleMobilePlaylist() {
            const wrapper = document.getElementById('playlist-wrapper');
            const btn = document.getElementById('mobile-queue-btn');
            
            // Toggle visibility classes
            if (wrapper.classList.contains('hidden')) {
                wrapper.classList.remove('hidden');
                wrapper.classList.add('flex', 'absolute', 'top-14', 'right-0', 'z-50');
                btn.classList.add('bg-white/20');
            } else {
                wrapper.classList.add('hidden');
                wrapper.classList.remove('flex', 'absolute', 'top-14', 'right-0', 'z-50');
                btn.classList.remove('bg-white/20');
            }
        }

        function addToPlaylist(track) {
            playlist.push(track);
            renderPlaylist();
            
            // If it's the first track, prep it but don't auto-play unless user expects it
            // (Usually better to just add to queue, but if queue was empty/finished, maybe nothing happens)
            if (playlist.length === 1 && currentTrackIndex === -1) {
                // Optionally auto-play first added track?
                // Let's just select it visually
            }
            
            document.getElementById('playlist-count').innerText = playlist.length;
        }

        function renderPlaylist() {
            const container = document.getElementById('playlist-container');
            const emptyMsg = document.getElementById('empty-playlist-msg');
            
            // Clear current list items only
            container.innerHTML = '';
            
            if (playlist.length === 0) {
                // Show empty message
                if(emptyMsg) emptyMsg.classList.remove('hidden');
                return;
            }
            
            // Hide empty message
            if(emptyMsg) emptyMsg.classList.add('hidden');

            playlist.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = `playlist-item p-2 rounded cursor-pointer flex justify-between items-center group ${index === currentTrackIndex ? 'active' : ''}`;
                item.onclick = () => loadTrack(index);

                // Icon based on type
                let iconClass = 'fa-solid fa-file-audio text-blue-400'; // Default file
                if (track.type === 'soundcloud') iconClass = 'fa-brands fa-soundcloud text-orange-500';
                if (track.type === 'demo') iconClass = 'fa-solid fa-music text-purple-400';

                item.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <i class="${iconClass} text-xs w-4 text-center"></i>
                        <div class="flex flex-col overflow-hidden">
                            <span class="track-title text-xs text-gray-300 truncate w-40 font-medium">${track.title}</span>
                            <span class="text-[10px] text-gray-500 uppercase">${track.type}</span>
                        </div>
                    </div>
                    <button onclick="removeFromPlaylist(event, ${index})" class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-400 transition px-2">
                        <i class="fa-solid fa-times text-xs"></i>
                    </button>
                `;
                container.appendChild(item);
            });
        }

        function removeFromPlaylist(e, index) {
            e.stopPropagation(); // Prevent playing clicked track
            playlist.splice(index, 1);
            
            // Adjust current index if needed
            if (index < currentTrackIndex) {
                currentTrackIndex--;
            } else if (index === currentTrackIndex) {
                // If we removed the playing track, stop or play next
                stopCurrentAudio();
                currentTrackIndex = -1;
                document.getElementById('track-name').innerText = "Track Removed";
                document.getElementById('track-time').innerText = "0:00 / 0:00";
            }
            
            renderPlaylist();
            document.getElementById('playlist-count').innerText = playlist.length;
        }

        function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;

            initAudioContext();
            stopCurrentAudio();
            
            currentTrackIndex = index;
            renderPlaylist(); // Update active class
            
            const track = playlist[index];
            document.getElementById('track-name').innerText = track.title;
            
            // Show Loader
            document.getElementById('loading-overlay').classList.remove('hidden');

            if (track.type === 'file' || track.type === 'demo') {
                playFile(track);
            } else if (track.type === 'soundcloud') {
                playSoundCloud(track);
            }
        }

        function playNext(isManual = false) {
            if (playlist.length === 0) return;

            let nextIndex;
            
            if (isShuffle) {
                // Pick random index that isn't current (unless only 1 track)
                if (playlist.length === 1) nextIndex = 0;
                else {
                    do {
                        nextIndex = Math.floor(Math.random() * playlist.length);
                    } while (nextIndex === currentTrackIndex);
                }
            } else {
                nextIndex = currentTrackIndex + 1;
                if (nextIndex >= playlist.length) {
                    if (isLooping && !isManual) {
                         nextIndex = 0; // Loop back to start of playlist
                    } else if (isManual) {
                        nextIndex = 0; // Manual next on last track goes to first
                    } else {
                        return; // End of playlist
                    }
                }
            }
            
            loadTrack(nextIndex);
        }

        function playPrev() {
            if (playlist.length === 0) return;
            let prevIndex = currentTrackIndex - 1;
            if (prevIndex < 0) prevIndex = playlist.length - 1;
            loadTrack(prevIndex);
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            const btn = document.getElementById('shuffle-btn');
            if (isShuffle) {
                btn.classList.remove('text-gray-400');
                btn.classList.add('text-green-400');
            } else {
                btn.classList.add('text-gray-400');
                btn.classList.remove('text-green-400');
            }
        }

        // --- Input Handling ---

        function openAddModal() {
            document.getElementById('add-modal').classList.remove('hidden');
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
        }

        function showSoundCloudInput() {
            closeAddModal();
            document.getElementById('sc-input-modal').classList.remove('hidden');
            document.getElementById('sc-input').focus();
        }

        function closeSoundCloudInput() {
            document.getElementById('sc-input-modal').classList.add('hidden');
            // Re-open main add modal? optional.
            openAddModal(); 
        }

        function showDemoSelection() {
            closeAddModal();
            document.getElementById('demo-input-modal').classList.remove('hidden');
        }

        function closeDemoSelection() {
            document.getElementById('demo-input-modal').classList.add('hidden');
            openAddModal();
        }

        function addDemoTrack(filename, title) {
            addToPlaylist({
                type: 'demo',
                title: title,
                src: filename
            });
            // Close selection but maybe keep adding? No, usually close.
            closeDemoSelection();
            
            // If only track, play it
            if (playlist.length === 1 && !isPlaying) {
                loadTrack(0);
            }
        }

        function addSoundCloudTrack() {
            const url = document.getElementById('sc-input').value;
            if (!url.includes('soundcloud.com')) {
                alert("Please enter a valid SoundCloud URL");
                return;
            }
            
            // We don't know the title yet easily without fetching via API or waiting for widget load.
            // For now, we use a placeholder or extract slug.
            const slug = url.split('/').pop().replace(/-/g, ' ');
            const title = slug.charAt(0).toUpperCase() + slug.slice(1);

            addToPlaylist({
                type: 'soundcloud',
                title: title, // Refined later if possible
                src: url
            });

            document.getElementById('sc-input').value = "";
            document.getElementById('sc-input-modal').classList.add('hidden');
            
            // If queue was empty, play immediately? Or just leave it.
            // Let's play if it's the only track.
            if (playlist.length === 1 && !isPlaying) {
                loadTrack(0);
            }
        }

        function handleFileUpload(input) {
            if (input.files.length === 0) return;
            const file = input.files[0];
            const objectUrl = URL.createObjectURL(file);
            
            addToPlaylist({
                type: 'file',
                title: file.name,
                src: objectUrl,
                originalFile: file
            });

            closeAddModal();
            
            if (playlist.length === 1 && !isPlaying) {
                loadTrack(0);
            }
            
            // Reset input so same file can be selected again if needed
            input.value = '';
        }

        // --- Player Engines ---

        function playFile(track) {
            isSoundCloudMode = false;
            
            audioElement = new Audio();
            audioElement.src = track.src;
            audioElement.crossOrigin = "anonymous";
            // Important: We handle looping via playlist logic now, so element.loop is false usually.
            // Exception: Single track repeat? We'll assume "Loop" button means Loop Track (Repeat One)
            // or Loop Playlist. Standard visualizers usually Loop Track if enabled. 
            // The user asked for playlist shuffle. 
            // Let's implement Loop Button = Repeat Track. Playlist loops automatically if shuffle/next logic permits.
            // Actually standard player behavior: Loop = Repeat All or Repeat One. 
            // Let's stick to current logic: Loop Button loops the current track.
            audioElement.loop = isLooping;

            audioSource = audioContext.createMediaElementSource(audioElement);
            audioSource.connect(analyser);
            analyser.connect(gainNode);
            gainNode.connect(audioContext.destination);

            audioElement.onended = () => {
                if (!isLooping) playNext();
            };
            
            audioElement.ontimeupdate = updateProgress;

            audioElement.play().then(() => {
                isPlaying = true;
                document.getElementById('loading-overlay').classList.add('hidden');
                updateUIState(true, track.title);
                startVisualizer();
            }).catch(e => {
                console.error(e);
                document.getElementById('loading-overlay').classList.add('hidden');
                alert("Error playing file. Ensure '1.mp3', '2.mp3', etc. exist in the root directory for demo tracks.");
            });
        }

        function playSoundCloud(track) {
            isSoundCloudMode = true;
            
            const iframe = document.getElementById('sc-player');
            iframe.src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(track.src)}&auto_play=true&visual=false&buying=false&liking=false&download=false&sharing=false&show_artwork=false&show_comments=false&show_playcount=false&show_user=false`;

            if (!scWidget && window.SC) {
                scWidget = SC.Widget(iframe);
            }

            if(scWidget) {
                scWidget.unbind(SC.Widget.Events.READY);
                scWidget.unbind(SC.Widget.Events.PLAY);
                scWidget.unbind(SC.Widget.Events.PAUSE);
                scWidget.unbind(SC.Widget.Events.FINISH);

                scWidget.bind(SC.Widget.Events.READY, function() {
                    // Update Title from widget if possible
                    scWidget.getCurrentSound(function(sound) {
                        if(sound && sound.title) {
                            track.title = sound.title;
                            document.getElementById('track-name').innerText = sound.title;
                            renderPlaylist(); // Update title in list
                        }
                    });

                    scWidget.getDuration(function(dur) {
                        scDuration = dur;
                        if (scDuration === 0) {
                            alert("Track failed to load.");
                            document.getElementById('loading-overlay').classList.add('hidden');
                            return;
                        }
                        
                        document.getElementById('loading-overlay').classList.add('hidden');
                        scWidget.setVolume(document.getElementById('volume-slider-desktop').value * 100);
                        scWidget.play();
                    });
                });
                
                scWidget.bind(SC.Widget.Events.PLAY, function() {
                    isPlaying = true;
                    updatePlayButton();
                    startSCProgressPolling();
                    updateUIState(true, track.title);
                    startVisualizer();
                });

                scWidget.bind(SC.Widget.Events.PAUSE, function() {
                    isPlaying = false;
                    updatePlayButton();
                });

                scWidget.bind(SC.Widget.Events.FINISH, function() {
                    isPlaying = false;
                    if(isLooping) {
                        scWidget.seekTo(0);
                        scWidget.play();
                    } else {
                        playNext();
                    }
                });
            }
        }

        // --- Common Controls & UI ---

        function stopCurrentAudio() {
            if (audioSource) {
                try { audioSource.disconnect(); } catch(e){}
            }
            if (audioElement) {
                audioElement.pause();
                audioElement.src = "";
                audioElement = null;
            }
            if (scWidget) {
                scWidget.pause();
            }
            clearInterval(scPollInterval);
            cancelAnimationFrame(animationId);
            isPlaying = false;
            updatePlayButton();
        }

        function togglePlay() {
            if (isSoundCloudMode && scWidget) {
                scWidget.isPaused(function(paused) {
                    if (paused) scWidget.play();
                    else scWidget.pause();
                });
            } else if (audioElement) {
                if (audioElement.paused) audioElement.play();
                else audioElement.pause();
                isPlaying = !audioElement.paused;
                updatePlayButton();
            }
        }

        function toggleLoop() {
            isLooping = !isLooping;
            if (audioElement) audioElement.loop = isLooping;
            
            const btn = document.getElementById('loop-btn');
            if (isLooping) {
                btn.classList.remove('text-gray-400');
                btn.classList.add('text-blue-400', 'shadow-blue-500/50');
            } else {
                btn.classList.add('text-gray-400');
                btn.classList.remove('text-blue-400', 'shadow-blue-500/50');
            }
        }

        function toggleMobileVolume() {
            const container = document.getElementById('mobile-vol-container');
            container.classList.toggle('hidden');
        }

        function setVolume(val) {
            // Update Sync
            const desk = document.getElementById('volume-slider-desktop');
            const mob = document.getElementById('volume-slider-mobile');
            
            if (desk) {
                desk.value = val;
                updateRangeBackground(desk);
            }
            if (mob) {
                mob.value = val;
                updateRangeBackground(mob);
            }

            if (isSoundCloudMode && scWidget) scWidget.setVolume(val * 100);
            if (gainNode) gainNode.gain.value = val;
            
            const iconD = document.getElementById('vol-icon-desktop');
            const iconM = document.getElementById('vol-icon-mobile');
            let cls = "fa-solid fa-volume-high";
            if(val == 0) cls = "fa-solid fa-volume-off";
            else if(val < 0.5) cls = "fa-solid fa-volume-low";
            
            if(iconD) iconD.className = cls;
            if(iconM) iconM.className = cls;
        }

        function toggleMute() {
            const slider = document.getElementById('volume-slider-desktop'); // Use desktop as source of truth
            setVolume(slider.value > 0 ? 0 : 0.8);
        }

        function updateProgress() {
            if (!audioElement) return;
            const progress = (audioElement.currentTime / audioElement.duration) * 100;
            const slider = document.getElementById('seek-slider');
            if(slider) {
                slider.value = progress || 0;
                updateRangeBackground(slider);
            }
            formatTime(audioElement.currentTime * 1000, audioElement.duration * 1000);
        }

        function startSCProgressPolling() {
            clearInterval(scPollInterval);
            scPollInterval = setInterval(() => {
                if (isSoundCloudMode && scWidget && isPlaying) {
                    scWidget.getPosition(function(pos) {
                        const progress = (pos / scDuration) * 100;
                        const slider = document.getElementById('seek-slider');
                        if(slider) {
                            slider.value = progress;
                            updateRangeBackground(slider);
                        }
                        formatTime(pos, scDuration);
                    });
                }
            }, 500);
        }

        function formatTime(currentMs, durationMs) {
            const curSecsTotal = Math.floor(currentMs / 1000);
            const durSecsTotal = Math.floor(durationMs / 1000) || 0;
            const curMins = Math.floor(curSecsTotal / 60);
            const curSecs = curSecsTotal % 60;
            const durMins = Math.floor(durSecsTotal / 60);
            const durSecs = durSecsTotal % 60;
            document.getElementById('track-time').innerText = 
                `${curMins}:${curSecs < 10 ? '0'+curSecs : curSecs} / ${durMins}:${durSecs < 10 ? '0'+durSecs : durSecs}`;
        }

        function seekAudio(val) {
            if (isSoundCloudMode && scWidget && scDuration) {
                scWidget.seekTo((val / 100) * scDuration);
            } else if (audioElement) {
                audioElement.currentTime = (val / 100) * audioElement.duration;
            }
            updateRangeBackground(document.getElementById('seek-slider'));
        }

        function updateUIState(playing, trackName) {
            document.getElementById('play-btn').disabled = false;
            document.getElementById('seek-slider').disabled = false;
            document.getElementById('status-text').innerText = "Playing";
            if (trackName) document.getElementById('track-name').innerText = trackName;
            updatePlayButton();
        }

        function updatePlayButton() {
            const btn = document.getElementById('play-btn');
            btn.innerHTML = isPlaying ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>';
        }

        function setVisualizerMode(mode) {
            currentMode = mode;
            const modes = ['bars', 'radial'];
            const pill = document.getElementById('selector-pill');
            
            modes.forEach(m => {
                const btn = document.getElementById(`btn-${m}`);
                if (m === mode) {
                    btn.classList.remove('text-gray-400', 'hover:text-white');
                    btn.classList.add('text-black');
                    if (pill) {
                        pill.style.opacity = '1';
                        pill.style.width = `${btn.offsetWidth}px`;
                        pill.style.height = `${btn.offsetHeight}px`;
                        pill.style.left = `${btn.offsetLeft}px`;
                    }
                } else {
                    btn.classList.remove('text-black');
                    btn.classList.add('text-gray-400', 'hover:text-white');
                }
            });
        }

        // --- Visualizer Engines ---
        
        function generateSimulatedData() {
            const time = Date.now() / 1000;
            for (let i = 0; i < bufferLength; i++) {
                if (!isPlaying) {
                    dataArray[i] = Math.max(0, dataArray[i] - 5);
                    continue;
                }
                const angle = (i * 0.03) - (time * 2);
                const rawSine = Math.sin(angle);
                let value = ((rawSine + 1) / 2) * 180 + 20;
                dataArray[i] = value;
            }
        }

        function startVisualizer() {
            function draw() {
                animationId = requestAnimationFrame(draw);
                
                if (isSoundCloudMode) {
                    generateSimulatedData();
                } else {
                    analyser.getByteFrequencyData(dataArray);
                }

                ctx.clearRect(0, 0, width, height);

                if (currentMode === 'bars') drawBars();
                else if (currentMode === 'radial') drawRadial();
            }
            draw();
        }

        function drawBars() {
            // Dynamic bar count based on screen width
            const targetBarWidth = 12; // Approximation
            const barCount = Math.ceil(width / targetBarWidth); 
            const barWidth = width / barCount;
            
            let x = 0;
            for (let i = 0; i < barCount; i++) {
                // Map to lower 75% of frequency to avoid empty high-end
                const index = Math.floor(i * (bufferLength / barCount) * 0.75); 
                const value = dataArray[index] || 0; // Safe access

                const barHeight = (value / 255) * height * 0.8;
                const hue = i * 2 + (value / 4);
                
                ctx.fillStyle = `hsl(${hue}, 80%, 50%)`;
                ctx.beginPath();
                ctx.roundRect(x, height - barHeight, barWidth - 1, barHeight, [5, 5, 0, 0]);
                ctx.fill();
                
                // Reflection
                ctx.fillStyle = `hsla(${hue}, 80%, 50%, 0.1)`;
                ctx.fillRect(x, height, barWidth - 1, barHeight * 0.3);
                
                x += barWidth;
            }
        }

        function drawRadial() {
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 4;
            const bars = 100;
            const step = (Math.PI * 2) / bars;

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius - 10, 0, Math.PI * 2);
            ctx.fillStyle = '#000';
            ctx.fill();

            for (let i = 0; i < bars; i++) {
                const index = Math.floor(i * (bufferLength / bars) * 0.5); 
                const value = dataArray[index];
                const barHeight = (value / 255) * (Math.min(width, height) / 3);
                const angle = i * step;
                const startX = centerX + Math.cos(angle) * radius;
                const startY = centerY + Math.sin(angle) * radius;
                const endX = centerX + Math.cos(angle) * (radius + barHeight);
                const endY = centerY + Math.sin(angle) * (radius + barHeight);
                const hue = (i / bars) * 360 + (value / 2);
                ctx.strokeStyle = `hsl(${hue}, 70%, 60%)`;
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
            }
            const bassAvg = dataArray.slice(0, 10).reduce((a, b) => a + b, 0) / 10;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.8, 0, Math.PI * 2);
            ctx.fillStyle = `hsla(${bassAvg}, 70%, 50%, 0.2)`;
            ctx.fill();
        }
    </script>
</body>
</html>
